import kivy
import Database.DBLayer as db
from kivy.app import App
from kivy.uix.checkbox import CheckBox
from kivy.uix.label import Label
from kivy.uix.gridlayout import GridLayout
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.textinput import TextInput
from kivy.uix.screenmanager import ScreenManager, Screen
from kivy.uix.button import Button
from kivy.uix.behaviors import ButtonBehavior
from kivy.uix.image import Image
from kivy.clock import Clock
from kivy.properties import ObjectProperty

kivy.require("1.10.1")

# TODO move to properties and add properties reader
BUTTON_FONT_SIZE = 22
BUTTON_SIZE = (1.5, .5)
BUTTON_BACKGROUND_COLOR = [1, 1, 1, .3]
BUTTON_COLOR = [1, 1, 1, .5]


list_name = "asd"


class ListsPage(GridLayout):
    # runs on initialization
    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        self.cols = 1

        # TODO - add another class for converting dblayer to list of dict
        # TODO - add support for all dblayer def
        values = db.read_lists()
        fields = ["id", "name", "order_id", "created_date", ]
        lists = [dict(zip(fields, d)) for d in values]

        values = db.read_entries()
        fields = ["id", "list_id", "name", "is_completed", "created_date", "due_date", "frequency", ]
        entries = [dict(zip(fields, d)) for d in values]

        list_1_entries_count = str(db.read_entries_count(1)[0][0])
        list_2_entries_count = str(db.read_entries_count(2)[0][0])
        list_3_entries_count = str(db.read_entries_count(3)[0][0])
        list_4_entries_count = str(db.read_entries_count(4)[0][0])

        # TODO need to add buttons to Lists dynamically based on db state
        list_1_description = lists[0]["name"]
        list_2_description = lists[1]["name"]
        list_3_description = lists[2]["name"]
        list_4_description = lists[3]["name"]


        # Upper Panel
        self.upper_panel = GridLayout(cols=3, size_hint=(0.1, 0.1))

        self.upper_panel.settings_button = Button(text="Settings", background_color=BUTTON_BACKGROUND_COLOR, color=BUTTON_COLOR, )
        self.upper_panel.add_widget(self.upper_panel.settings_button)
        # self.lists_panel.settings_button.bind(on_press=self.settings_button_press)

        self.upper_panel.add_widget(Button(text="Edit", background_color=BUTTON_BACKGROUND_COLOR, color=BUTTON_COLOR, size_hint=(None, 0.1), width=50))
        self.upper_panel.add_widget(Button( background_color=BUTTON_BACKGROUND_COLOR, color=BUTTON_COLOR, size_hint=(None, 0.1), width=50, background_normal="images/search_button.png",
            background_down="images/search_button.png",))

        self.add_widget(self.upper_panel)

        # Lists buttons
        self.lists_panel = GridLayout(cols=2,)

        self.lists_panel.list_1 = Button(text=list_1_description, font_size=BUTTON_FONT_SIZE, size_hint=BUTTON_SIZE,)
        self.lists_panel.list_1.bind(on_press=self.list_button_press)
        self.lists_panel.add_widget(self.lists_panel.list_1)

        self.lists_panel.label_1 = Label(text=list_1_entries_count, width=50)
        self.lists_panel.add_widget(self.lists_panel.label_1)

        self.lists_panel.list_2 = Button(text=list_2_description, font_size=BUTTON_FONT_SIZE, size_hint=BUTTON_SIZE,)
        self.lists_panel.list_2.bind(on_press=self.list_button_press)
        self.lists_panel.add_widget(self.lists_panel.list_2)

        self.lists_panel.label_2 = Label(text=list_2_entries_count)
        self.lists_panel.add_widget(self.lists_panel.label_2)

        self.lists_panel.list_3 = Button(text=list_3_description, font_size=BUTTON_FONT_SIZE, size_hint=BUTTON_SIZE,)
        self.lists_panel.list_3.bind(on_press=self.list_button_press)
        self.lists_panel.add_widget(self.lists_panel.list_3)

        self.lists_panel.label_3 = Label(text=list_3_entries_count)
        self.lists_panel.add_widget(self.lists_panel.label_3)

        self.lists_panel.list_4 = Button(text=list_4_description, font_size=BUTTON_FONT_SIZE, size_hint=BUTTON_SIZE,)
        self.lists_panel.list_4.bind(on_press=self.list_button_press)
        self.lists_panel.add_widget(self.lists_panel.list_4)

        self.lists_panel.label_4 = Label(text=list_3_entries_count)
        self.lists_panel.add_widget(self.lists_panel.label_4)

        self.add_widget(self.lists_panel)

        # Bottom Panel
        self.bottom_panel = GridLayout(cols=1, size_hint=(0.15, 0.15))
        self.bottom_panel.add_widget(Button(text="Create new List", background_color=BUTTON_BACKGROUND_COLOR, color=BUTTON_COLOR, ))
        self.add_widget(self.bottom_panel)

    def list_button_press(self, instance):
        global list_name
        list_name = "aasdasdasdasd"
        print(self.parent)

        chat_app.screen_manager.transition.direction = 'left'
        chat_app.screen_manager.current = 'Entries'


class EntriesPage(FloatLayout):
    # TODO - open entries screen
    # TODO - need to add entries  dynamically based on db state
    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        def on_checkbox_active(checkbox, value):
            if value:
                print('The checkbox', checkbox, 'is active')
            else:
                print('The checkbox', checkbox, 'is inactive')

        # Setting button
        self.setting_btn = Button(text=list_name, font_size=BUTTON_FONT_SIZE, size_hint=(0.7, 0.05), pos_hint={'x': 0, 'y': 0.95},)
        # self.setting_btn.bind(on_press=self.list_button_press)
        self.add_widget(self.setting_btn)

        # Edit button
        self.edit_btn = Button(text="Edit", font_size=BUTTON_FONT_SIZE, size_hint=(0.15, 0.05), pos_hint={'x': 0.7, 'y': 0.95},)
        # self.back_to_lists.bind(on_press=self.open_screen_lists)
        self.add_widget(self.edit_btn)

        # Empty place
        #self.txt_input = TextInput(text="Text Input", font_size=BUTTON_FONT_SIZE, size_hint=(0.15, 0.05), pos_hint={'x': 0.85, 'y': 0.9})
        # self.back_to_lists.bind(on_press=self.open_screen_lists)
        #self.add_widget(self.txt_input)

        self.txt_input = TextInput(text="Text Input", font_size=BUTTON_FONT_SIZE, size_hint=(1, 0.1), pos_hint={'x': 0, 'y': 0.85})
        # self.back_to_lists.bind(on_press=self.open_screen_lists)
        self.add_widget(self.txt_input)


        # Entry 1
        self.Entry_1 = Label(text="Sugar",  font_size=BUTTON_FONT_SIZE, size_hint=(0.8, 0.1), pos_hint={'x': 0, 'y': 0.75})
        self.add_widget(self.Entry_1)

        # Entry 1 Checkbox
        self.entry_1_checkbox = CheckBox( active=True, size_hint=(0.2, 0.1), pos_hint={'x': 0.8, 'y': 0.75})
        self.entry_1_checkbox.bind(active=on_checkbox_active)

        # Entry 2
        self.Entry_2 = Label(text="Bread", font_size=BUTTON_FONT_SIZE, size_hint=(0.8, 0.1), pos_hint={'x': 0, 'y': .65})
        self.add_widget(self.Entry_2)

        # Entry 2 Checkbox
        self.entry_2_checkbox = CheckBox(active=True, size_hint=(0.2, 0.1), pos_hint={'x': 0.8, 'y': 0.65})
        self.entry_2_checkbox.bind(active=on_checkbox_active)

        # Back button
        self.back_to_lists = Button(text="Back", font_size=BUTTON_FONT_SIZE, size_hint=(1, 0.1), pos_hint={'x': 0, 'y': 0}, pos=(1, 1))
        self.back_to_lists.bind(on_press=self.open_screen_lists)
        self.add_widget(self.back_to_lists)



    def open_screen_lists(self, instance):

        chat_app.screen_manager.transition.direction = 'right'
        chat_app.screen_manager.current = 'Lists'


class EpicApp(App):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.screen_manager = ScreenManager()
        self.lists_page = ListsPage()
        self.entries_page = EntriesPage()

    def build(self):

        # Lists page
        screen = Screen(name='Lists')
        screen.add_widget(self.lists_page)
        self.screen_manager.add_widget(screen)

        # Entries page
        screen = Screen(name='Entries')
        screen.add_widget(self.entries_page)
        self.screen_manager.add_widget(screen)

        return self.screen_manager


if __name__ == "__main__":
    chat_app = EpicApp()
    chat_app.run()
